<!doctype html>
<html lang="en">
  <head>
    <title>JavaScript Example - Getting Started - Quick Start Example</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex" />
    
    <style media="only screen">
      :root,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        box-sizing: border-box;
        -webkit-overflow-scrolling: touch;
      }

      html {
        position: absolute;
        top: 0;
        left: 0;
        padding: 0;
        overflow: auto;
        font-family: -apple-system, "system-ui", "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif,
          "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
          "Noto Color Emoji";
      }

      body {
        padding: 2px;
        overflow: auto;
        background-color: transparent;
      }

      .ag-cell {
        display : flex ; /* ä½¿ç”¨ Flexbox å¸ƒå±€ */
        align-items : center ; /* å‚ç›´å±…ä¸­ */
    }

    </style>
    <link rel="stylesheet" href="./productCellRenderer.css">
    <link rel="stylesheet" href="./statusCellRenderer.css">

  </head>
  <body>
    
    
<div id="status">æœªè¿æ¥â€¦â€¦</div>
    <div id="message">å‡†å¤‡ğŸ”—</div>
    <div id="myGrid" style="width: 100%; height: 100%"></div>
    <script>
      (function () {
        const appLocation = "";
        window.__basePath = appLocation;
      })();

    </script>

    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@33.1.1/dist/ag-grid-community.min.js?t=1741259897572"></script>
   

    <script src="./productCellRenderer.js"></script>  
    <script src="./statusCellRenderer.js"></script>  

    <script>  

 

// ä½¿ç”¨ AG Grid çš„ Quartz ä¸»é¢˜ï¼Œå¹¶é€šè¿‡ `withParams` æ–¹æ³•è‡ªå®šä¹‰ä¸»é¢˜å‚æ•°
const myTheme = agGrid.themeQuartz
  .withParams({
    backgroundColor: "#1f2836", // è®¾ç½®èƒŒæ™¯é¢œè‰²ä¸ºæ·±è‰²
    browserColorScheme: "dark", // æŒ‡å®šæµè§ˆå™¨é¢œè‰²æ–¹æ¡ˆä¸ºæ·±è‰²æ¨¡å¼
    chromeBackgroundColor: {
      ref: "foregroundColor", // ä½¿ç”¨å‰æ™¯è‰²ä½œä¸ºå‚è€ƒ
      mix: 0.07, // æ··åˆæ¯”ä¾‹
      onto: "backgroundColor" // æ··åˆåˆ°èƒŒæ™¯é¢œè‰²ä¸Š
    },
    foregroundColor: "#FFF", // è®¾ç½®å‰æ™¯é¢œè‰²ä¸ºç™½è‰²
    headerFontSize: 14, // è®¾ç½®è¡¨å¤´å­—ä½“å¤§å°ä¸º 14px
    oddRowBackgroundColor: "#26354F" // è®¾ç½®å¥‡æ•°è¡Œçš„èƒŒæ™¯é¢œè‰²ä¸ºæ·±è“è‰²
  });

function formatDate(timestamp, format = 'month-day hours:minute') {
  const date = new Date(timestamp * 1000); // å°†ç§’çº§æ—¶é—´æˆ³è½¬æ¢ä¸ºæ¯«ç§’
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');

  const formatMap = {
    'month': month,
    'day': day,
    'hours': hours,
    'minute': minutes,
  };

  // æ›¿æ¢æ ¼å¼å­—ç¬¦ä¸²ä¸­çš„å ä½ç¬¦
  return format.replace(/month|day|hours|minute/g, match => formatMap[match]);
}




// å®šä¹‰çŠ¶æ€æ˜ å°„å¯¹è±¡ï¼Œç”¨äºå°†çŠ¶æ€å€¼è½¬æ¢ä¸ºå¯è¯»çš„æ–‡æœ¬

const statuses = {
"1":"ç”¨æˆ·å·²æäº¤è®¢å•",
"2":"å‘å•†å®¶æ¨é€è®¢å•",
"4":"å•†å®¶å·²ç¡®è®¤",
"8":"è®¢å•å·²å®Œæˆ",
"9":"è®¢å•å·²å–æ¶ˆ",
};

// è‡ªå®šä¹‰çŠ¶æ€æ ¼å¼åŒ–å‡½æ•°
// å¦‚æœ `value` ä¸åœ¨ `statuses` ä¸­ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
const statusFormatter = ({value})=>statuses[value] ?? value;
    

let immutableStore = [];

// Grid Options: åŒ…å«æ‰€æœ‰ AG Grid çš„é…ç½®
const gridOptions = {
defaultColDef: {
    resizable: true,
  },
  // åˆ—å®šä¹‰ï¼ŒæŒ‡å®šæ¯ä¸€åˆ—çš„æ˜¾ç¤ºæ–¹å¼å’Œå±æ€§
  columnDefs: [
    {
      field: "day_seq", // æ•°æ®å­—æ®µå
      headerName: "æµæ°´å·", // åˆ—æ ‡é¢˜
      //type: "rightAligned", // æ–‡æœ¬å³å¯¹é½
      flex: 0.3, // åˆ—å®½åº¦å æ¯”
      cellRenderer: (params) => {
          return `<div class="DaySeq">#${params.data.day_seq}</div>`;
        },
    },
    {
      field: "is_pre_order", // æ˜¯å¦ä¸ºé¢„å®šå•
      headerName: "é¢„å®šå•", // åˆ—æ ‡é¢˜
      flex: 0.3, // åˆ—å®½åº¦å æ¯”
      cellRenderer: StatusCellRenderer, 
      cellRendererParams:{rendererType:"isPre"},
    },
    {
      field: "pick_type", // æ˜¯å¦ä¸ºè‡ªå–
      headerName: "é…é€", // åˆ—æ ‡é¢˜
      flex: 0.3,
      cellRenderer: StatusCellRenderer, // ä½¿ç”¨è‡ªå®šä¹‰çš„å•å…ƒæ ¼æ¸²æŸ“å™¨
      cellRendererParams:{rendererType:"pick"},
    },
    {
      field: "status", // è®¢å•çŠ¶æ€
      headerName: "è®¢å•çŠ¶æ€", // åˆ—æ ‡é¢˜
      flex: 0.4,
      valueFormatter: statusFormatter, // ä½¿ç”¨è‡ªå®šä¹‰çš„çŠ¶æ€æ ¼å¼åŒ–å‡½æ•°
      cellRenderer: StatusCellRenderer, // ä½¿ç”¨è‡ªå®šä¹‰çš„å•å…ƒæ ¼æ¸²æŸ“å™¨
      cellRendererParams:{rendererType:"orderStatus"},
  
    },
    {
      field: "estimate_arrival_time", // é¢„è®¡é€è¾¾æ—¶é—´
      headerName: "é¢„è®¡é€è¾¾æ—¶é—´", // åˆ—æ ‡é¢˜
      flex: 0.4,
      cellRenderer: (params) => {
        return `<div>${formatDate(params.data.estimate_arrival_time)}</div>`;
      }
    },
    {
      field: "caution", // å¤‡æ³¨
      headerName: "å¤‡æ³¨", // åˆ—æ ‡é¢˜
      flex: 0.5,
    },
  
   
    { field: "detail", headerName: "å•†å“è¯¦æƒ…", 
     flex: 3,
    cellRenderer: (params) => {
      const detail = params.data.detail;
      return `
        <div class="productCellGroup">
          ${detail.map((item, index) => `
            <div class="productCell" style="display:flex; flex-direction: row;">
                <div class = "image">

                <div class="stockCell" style="background-color: rgba(${item.item_count>1?230:12}, 27, 38, 0.7)">Ã—${item.item_count}</div>
                    <img src="${item.image}" alt="${item.image}" />
                </div>
                <div class="prodText">
                    <div>${item.food_name}</div>
                    
                </div>
            </div>
          `).join("")}
        </div>
      `;
    },

     }, 
       
  ],



  // åº”ç”¨è‡ªå®šä¹‰ä¸»é¢˜
  theme: myTheme,

  // è®¾ç½®è¡Œé«˜ä¸º 80 åƒç´ 
  getRowHeight: params => (params.data.detail.length/5+1) * 125,

  onGridReady: (params) => {


    fetch("/data.json")
    .then((response) => response.json())
    .then((data) => {
    gridApi.setGridOption("rowData", data);
    immutableStore=data;
    });


  },
};

// å®šä¹‰å…¨å±€å˜é‡ `gridApi`ï¼Œç”¨äºæ“ä½œç½‘æ ¼å®ä¾‹
let gridApi;



// åˆ›å»º AG Grid å®ä¾‹
// åœ¨é¡µé¢ä¸­æ‰¾åˆ° `#myGrid` å…ƒç´ ï¼Œå¹¶ä½¿ç”¨ `gridOptions` é…ç½®åˆå§‹åŒ–ç½‘æ ¼


gridApi = agGrid.createGrid(document.querySelector("#myGrid"), gridOptions);



    </script>


    <script>
// é…ç½®å‚æ•°
const WEBSOCKET_URL = 'ws://192.168.1.181:8080/ws';
const RECONNECT_INTERVAL = 3000; // 3ç§’é‡è¯•é—´éš”
let ws = null;
let reconnectTimer = null;




// åˆ›å»ºWebSocketè¿æ¥
function createWebSocketConnection() {
    ws = new WebSocket(WEBSOCKET_URL);

    ws.onopen = () => {
        document.getElementById('status').textContent = 'å·²è¿æ¥';
        startHeartbeat();
        console.log('WebSocketè¿æ¥å·²å»ºç«‹');
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const newStore = immutableStore.slice();
        newStore.push(data);
        //è¿™é‡Œéœ€è¦å¯¹newStoreè¿›è¡Œé‡æ’åºï¼ŒnewStoreæ˜¯ä¸€ä¸ªjsonæ•°ç»„ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªestimate_arrival_timeå±æ€§ï¼ŒæŒ‰estimate_arrival_timeå±æ€§å‡åºæ’åˆ—
        // æŒ‰ç…§ estimate_arrival_time å±æ€§é™åºæ’åº
        newStore.sort((a, b) => {
        const timeA = parseInt(a.estimate_arrival_time, 10); // ç¡®ä¿æ˜¯æ•°å­—
        const timeB = parseInt(b.estimate_arrival_time, 10);
        return timeA - timeB; // å‡åºæ’åº
         });

        immutableStore = newStore;

        gridApi.setGridOption("rowData", immutableStore);
    };

    ws.onerror = (error) => {
        console.error('WebSocketé”™è¯¯:', error);
        handleDisconnect();
    };

    ws.onclose = (event) => {
        console.log('WebSocketè¿æ¥å…³é—­:', event.code, event.reason);
        handleDisconnect();
    };
}

// å¿ƒè·³æœºåˆ¶ï¼ˆä¿æŒè¿æ¥æ´»è·ƒï¼‰
function startHeartbeat() {
    if(ws) {
        ws.send(JSON.stringify({
            type: 'heartbeat',
            timestamp: Date.now()
        }));

        // è®¾ç½®å®šæ—¶å¿ƒè·³
        setInterval(() => {
            if(ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'heartbeat',
                    timestamp: Date.now()
                }));
            }
        }, 60000); // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
    }
}

// å¤„ç†æ–­å¼€è¿æ¥
function handleDisconnect() {
    if(ws) {
        ws.close(1000, 'æ­£å¸¸å…³é—­'); // æ¸…ç†æ—§è¿æ¥
        ws = null;
    }

    document.getElementById('status').textContent = 'è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡è¿...';
    console.log('å¼€å§‹è‡ªåŠ¨é‡è¿...');

    // é‡è¯•è¿æ¥
    if(reconnectTimer) clearTimeout(reconnectTimer);
    reconnectTimer = setTimeout(createWebSocketConnection, RECONNECT_INTERVAL);
}

// åˆå§‹åŒ–è¿æ¥
const messagesDiv = document.getElementById('messages');
createWebSocketConnection();

// çª—å£å…³é—­æ—¶ä¿æŒé‡è¿
window.addEventListener('beforeunload', () => {
    if(ws) {
        ws.close(1000, 'çª—å£å…³é—­');
    }
});

// çª—å£æ‰“å¼€æ—¶è‡ªåŠ¨é‡è¿
window.addEventListener('load', () => {
    if(!ws || ws.readyState !== WebSocket.OPEN) {
        createWebSocketConnection();
    }
});
</script>

  </body>
</html>
